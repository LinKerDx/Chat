<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinKDx's Chat</title>
    <script type="module">
    import { io } from 'https://cdn.socket.io/4.3.2/socket.io.esm.min.js'
    
    const getUserName = async () => {
        const username = localStorage.getItem('username')
        if (username) return username
        const name = prompt('What is your name?')
        if(name){
            localStorage.setItem('username', name)
            return name
        }
        return 'Anonymous'
    }
    
    const currentUser = await getUserName()

    const socket = io({
        auth: {
            user: currentUser,

            serverOffset: 0,
        }
    })

    const form = document.getElementById('form')
    const input = document.getElementById('input')
    const messages = document.getElementById('messages')

    let lastMinute = null

    const formatTime = (date) => {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
    }

    const getCurrentMinute = (date) => {
        return `${date.getHours()}:${date.getMinutes()}`
    }

    const createTimestamp = (time) => {
        return `<li class="timestamp">
                    <span class="time-label">${time}</span>
                </li>`
    }

    const createMessage = (msg, username, isSent) => {
        const messageClass = isSent ? 'message-sent' : 'message-received'
        return `<li class="message ${messageClass}">
                    <div class="message-content">
                        <p>${msg}</p>
                        <small class="username">${username}</small>
                    </div>
                </li>`
    }

    socket.on('chat message', (msg, serverOffset, username, timestamp) => {
        const messageTime = timestamp ? new Date(timestamp) : new Date()
        const currentMinute = getCurrentMinute(messageTime)

        if (lastMinute !== currentMinute) {
            const timestampItem = createTimestamp(formatTime(messageTime))
            messages.insertAdjacentHTML('beforeend', timestampItem)
            lastMinute = currentMinute
        }
        
        const isSent = username === currentUser
        const item = createMessage(msg, username, isSent)
        
        messages.insertAdjacentHTML('beforeend', item)
        socket.auth.serverOffset = serverOffset
        window.scrollTo(0, document.body.scrollHeight)
    })

    form.addEventListener('submit', (e) => {
        e.preventDefault()
        if(input.value){
            socket.emit('chat message', input.value)
            input.value = ''
        }
    })
    </script>
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        :root{
            color-scheme: light dark;
        }
        
        body {
            margin: 0;
            padding: 36px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;           
            display: grid;
            height: 100vh;
            grid-template-rows: 1fr;
            place-content: center;
            background-color: #f0f2f5;
        }

        #messages {
            list-style-type: none;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            height: calc(100% - 80px);
        } 

        .message {
            max-width: 70%;
            margin: 5px 0;
        }

        .timestamp {
            text-align: center;
            margin: 15px 0;
            list-style: none;
        }

        .time-label {
            background-color: rgba(0,0,0,0.1);
            color: #666;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .message-sent {
            align-self: flex-end;
        }

        .message-sent .message-content {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 20px 20px 5px 20px;
            padding: 12px 16px;
            box-shadow: 0 2px 5px rgba(0,123,255,0.3);
        }

        .message-received {
            align-self: flex-start;
        }

        .message-received .message-content {
            background-color: #e5e5ea;
            color: #333;
            border-radius: 20px 20px 20px 5px;
            padding: 12px 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .message-content p {
            margin: 0 0 5px 0;
            word-wrap: break-word;
        }

        .message-sent .username {
            color: rgba(255,255,255,0.8);
            font-size: 11px;
            text-align: right;
            display: block;
        }

        .message-received .username {
            color: #666;
            font-size: 11px;
            text-align: left;
            display: block;
        }

        #chat{
            border: 1px solid #ddd;
            border-radius: 15px; 
            overflow: hidden;
            width: 400px;
            height: 600px;
            position: relative;
            background-color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .romboide {
            background-color: #2c8bca;
            color: white;
            padding: 8px 16px;
            border: none;
            transform: skewX(-20deg);
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin-left: 10px;
            border-radius: 5px;
        }

        .romboide:hover {
            background-color: #2980b9;
        }
        
        form{
            display: flex;
            position: absolute;
            gap: 10px;
            bottom: 0;
            width: 100%;
            background-color: #fff;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            align-items: center;
            border-top: 1px solid #eee;
        }

        #input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
            background-color: #f8f9fa;
        }

        #input:focus {
            border-color: #007bff;
            background-color: rgb(117, 117, 117);
        }

        .message {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #messages::-webkit-scrollbar {
            width: 6px;
        }

        #messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        #messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        #messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <section id="chat">
        <ul id="messages"></ul>
        <form id="form">
            <button type="button"><svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-paperclip"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 7l-6.5 6.5a1.5 1.5 0 0 0 3 3l6.5 -6.5a3 3 0 0 0 -6 -6l-6.5 6.5a4.5 4.5 0 0 0 9 9l6.5 -6.5" /></svg></button>
            <input type="text" name="message" id="input" placeholder="Type your message here..." autocomplete="off">
            <button type="submit" class="romboide">Send</button>
        </form>
    </section>
</body>
</html>